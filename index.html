
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Network Data Collection App</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { margin: 10px; padding: 15px 25px; font-size: 16px; border-radius: 8px; cursor: pointer; }
    #deleteBtn { background: #e74c3c; color: white; }
    #collectBtn { background: #2ecc71; color: white; }
    #downloadBtn { background: #3498db; color: white; }
  </style>
</head>
<body>
  <h1>ðŸ“¡ Network Data Collection</h1>

  <button id="collectBtn">Collect Data</button>
  <button id="downloadBtn">Download CSV</button>
  <button id="deleteBtn">Delete Last Row</button>

  <table id="dataTable">
    <tr>
      <th>Sl No</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Time</th>
      <th>Area</th>
      <th>Network Type</th>
      <th>Device</th>
      <th>Ping (ms)</th>
      <th>Latency (ms)</th>
      <th>Speed (Mbps)</th>
    </tr>
  </table>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // âœ… Correct Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBB4cqQQ2aYpHftMldsoqE5s-vyfiBKRtQ",
      authDomain: "g-latency-4f42c.firebaseapp.com",
      projectId: "g-latency-4f42c",
      storageBucket: "g-latency-4f42c.appspot.com",
      messagingSenderId: "967711061635",
      appId: "1:967711061635:web:92144a530baa967f86cdb6",
      measurementId: "G-QBTFWLQ5X8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let counter = 1;

    async function getArea(lat, lon) {
      try {
        let res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        let data = await res.json();
        if (data && data.address) {
          return data.address.city || data.address.town || data.address.county || data.address.state_district || "Unknown Area";
        }
      } catch {
        return "Unknown Area";
      }
      return "Unknown Area";
    }

    function getNetworkType() {
      let connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (connection && connection.effectiveType) {
        if (connection.effectiveType.includes("5g")) return "5G";
        if (connection.effectiveType.includes("4g")) return "4G";
        if (connection.effectiveType.includes("3g")) return "3G";
        if (connection.effectiveType.includes("2g")) return "2G";
        return connection.effectiveType.toUpperCase();
      }
      return navigator.onLine ? "WiFi/Data" : "Offline";
    }

    function getDeviceName() {
      let ua = navigator.userAgent;
      if (/android/i.test(ua)) return "Android Phone";
      if (/iPhone|iPad|iPod/i.test(ua)) return "iOS Device";
      if (/windows/i.test(ua)) return "Windows PC";
      if (/mac/i.test(ua)) return "Mac";
      return "Unknown Device";
    }

    async function measurePing() {
      let start = performance.now();
      await fetch("https://www.google.com", {mode: 'no-cors'}).catch(()=>{});
      return Math.round(performance.now() - start);
    }

    async function measureLatency() {
      let start = performance.now();
      await fetch("https://speed.hetzner.de/100MB.bin", {method:"HEAD"}).catch(()=>{});
      return Math.round(performance.now() - start);
    }

    async function measureSpeed() {
      let start = performance.now();
      let size = 500000; // ~500 KB
      await fetch("https://speed.hetzner.de/1MB.bin?cache=" + Math.random())
        .then(r => r.blob()).catch(()=>{});
      let duration = (performance.now() - start) / 1000;
      let speedMbps = ((size * 8) / (duration * 1024 * 1024)).toFixed(2);
      return speedMbps;
    }

    // âœ… Real-time listener to Firestore
    function loadData() {
      let table = document.getElementById("dataTable");

      onSnapshot(collection(db, "network_data"), (snapshot) => {
        // Clear table except header
        while (table.rows.length > 1) table.deleteRow(1);

        snapshot.forEach((docSnap) => {
          let data = docSnap.data();
          let row = table.insertRow();
          row.setAttribute("data-id", docSnap.id); // Store Firestore ID
          row.insertCell(0).innerText = data.sl_no;
          row.insertCell(1).innerText = data.latitude;
          row.insertCell(2).innerText = data.longitude;
          row.insertCell(3).innerText = data.time;
          row.insertCell(4).innerText = data.area;
          row.insertCell(5).innerText = data.network;
          row.insertCell(6).innerText = data.device;
          row.insertCell(7).innerText = data.ping;
          row.insertCell(8).innerText = data.latency;
          row.insertCell(9).innerText = data.speed;

          counter = Math.max(counter, data.sl_no + 1);
        });
      });
    }

    document.getElementById("collectBtn").onclick = async () => {
      if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        let lat = pos.coords.latitude;
        let lon = pos.coords.longitude;
        let time = new Date().toLocaleString();
        let area = await getArea(lat, lon);
        let network = getNetworkType();
        let device = getDeviceName();
        let ping = await measurePing();
        let latency = await measureLatency();
        let speed = await measureSpeed();

        try {
          await addDoc(collection(db, "network_data"), {
            sl_no: counter,
            latitude: lat.toFixed(6),
            longitude: lon.toFixed(6),
            time: time,
            area: area,
            network: network,
            device: device,
            ping: ping,
            latency: latency,
            speed: speed
          });
          counter++;
        } catch (err) {
          console.error("Error saving data:", err);
        }
      }, () => {
        alert("Location access denied. Please enable location.");
      });
    };

    document.getElementById("downloadBtn").onclick = () => {
      let table = document.getElementById("dataTable");
      let rows = [];
      for (let i=0; i<table.rows.length; i++) {
        let cols = table.rows[i].cells;
        let row = [];
        for (let j=0; j<cols.length; j++) row.push(cols[j].innerText);
        rows.push(row.join(","));
      }
      let csv = rows.join("\n");
      let blob = new Blob([csv], { type: "text/csv" });
      let url = window.URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.setAttribute("hidden", "");
      a.href = url;
      a.download = "network_data.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    document.getElementById("deleteBtn").onclick = async () => {
      let table = document.getElementById("dataTable");
      if (table.rows.length > 1) {
        let lastRow = table.rows[table.rows.length - 1];
        let docId = lastRow.getAttribute("data-id");
        if (docId) {
          await deleteDoc(doc(db, "network_data", docId));
        }
      }
    };

    // âœ… Load Firestore data when page loads
    window.onload = loadData;
  </script>
</body>
</html>
